name: Frontend CI/CD (Secure OTAP)

on:
  push:
    branches:
      - dev
      - test
      - stage
      - master

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: zerosoft-technologies/eventsmap-frontend-vue

jobs:
  build:
    name: Build, Scan & SBOM
    runs-on: ubuntu-latest
    outputs:
      env: ${{ steps.envname.outputs.env }}
      image_tag: ${{ steps.tag.outputs.image_tag }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      # 1️⃣ Detect OTAP environment
      - name: Set environment name
        id: envname
        run: |
          BRANCH="${GITHUB_REF##*/}"

          if [[ "$BRANCH" == "dev" ]]; then echo "env=dev" >> $GITHUB_OUTPUT; fi
          if [[ "$BRANCH" == "test" ]]; then echo "env=test" >> $GITHUB_OUTPUT; fi
          if [[ "$BRANCH" == "stage" ]]; then echo "env=stage" >> $GITHUB_OUTPUT; fi
          if [[ "$BRANCH" == "master" ]]; then echo "env=master" >> $GITHUB_OUTPUT; fi

      # 2️⃣ Generate tag: branch-SHA except prod (latest)
      - name: Set image tag
        id: tag
        run: |
          SHA=$(echo $GITHUB_SHA | cut -c1-8)
          BRANCH="${GITHUB_REF##*/}"
          if [[ "$BRANCH" == "master" ]]; then 
              TAG="latest"
          else 
              TAG="${BRANCH}-${SHA}"
          fi
          echo "image_tag=$TAG" >> $GITHUB_OUTPUT

      # 3️⃣ Prepare build-time .env.production (DO NOT REMOVE)
      - name: Create .env.production dynamically
        run: |
          echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" > .env.production

      # 4️⃣ Install & Build
      - name: Install dependencies
        run: npm ci

      # - name: Run Lint
      #   run: npm run lint

      - name: Build Project
        run: npm run build

      # 5️⃣ Login & Push immutable image
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Build & Push Docker image
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.image_tag }}"
          docker build \
            --build-arg VITE_API_URL="${{ secrets.VITE_API_URL }}" \
            -t $IMAGE .
          docker push $IMAGE

      # 6️⃣ SBOM generation
      - name: Generate SBOM (Syft)
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.image_tag }}

      # 7️⃣ Trivy Security Scan
      - name: Trivy Scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.image_tag }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'


  deploy:
    name: Deploy to VPS via Podman
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ needs.build.outputs.env }}

    steps:
      - uses: actions/checkout@v4

      # Select deployment vars
      - name: Set Deployment Variables
        id: dep
        run: |
          BRANCH="${GITHUB_REF##*/}"

          if [[ "$BRANCH" == "test" ]]; then
            echo "dir=eventsmap-test" >> $GITHUB_OUTPUT
            echo "compose=podman-compose.test.yml" >> $GITHUB_OUTPUT
            echo "tag=${{ needs.build.outputs.image_tag }}" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == "stage" ]]; then
            echo "dir=eventsmap-stage" >> $GITHUB_OUTPUT
            echo "compose=podman-compose.stage.yml" >> $GITHUB_OUTPUT
            echo "tag=${{ needs.build.outputs.image_tag }}" >> $GITHUB_OUTPUT
          elif [[ "$BRANCH" == "master" ]]; then
            echo "dir=eventsmap-prod" >> $GITHUB_OUTPUT
            echo "compose=podman-compose.prod.yml" >> $GITHUB_OUTPUT
            echo "tag=latest" >> $GITHUB_OUTPUT
          else
            echo "Dev branch: no deployment."
            exit 0
          fi

      # Setup SSH
      - name: SSH Setup
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}

      # Upload compose file
      - name: Upload Compose File
        run: |
          scp -P ${{ secrets.DEPLOY_PORT }} \
            ${{ steps.dep.outputs.compose }} \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }}:/home/minaxi/${{ steps.dep.outputs.dir }}/

      # Upload front-end env to server (keep as requested)
      - name: Upload .env
        run: |
          ssh -p ${{ secrets.DEPLOY_PORT }} \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }} "
              echo 'VITE_API_URL=${{ secrets.VITE_API_URL }}' > /home/minaxi/${{ steps.dep.outputs.dir }}/.env
            "

      # Login + Deploy
      - name: Deploy App
        run: |
          ssh -p ${{ secrets.DEPLOY_PORT }} \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }} "
              echo '${{ secrets.GHCR_PAT }}' | podman login ghcr.io -u ${{ github.actor }} --password-stdin &&
              cd /home/minaxi/${{ steps.dep.outputs.dir }} &&
              TAG='${{ steps.dep.outputs.tag }}' &&
              podman pull ghcr.io/zerosoft-technologies/eventsmap-frontend-vue:'${{ steps.dep.outputs.tag }}' &&
              podman-compose -f ${{ steps.dep.outputs.compose }} up -d --force-recreate
          "

