name: Frontend CI/CD (Secure OTAP)
on:
  push:
    branches:
      - dev
      - test
      - stage
      - master

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: zerosoft-technologies/eventsmap-frontend

jobs:
  # Step 1: Build and Test
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    outputs:
      env: ${{ steps.envname.outputs.env }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      # Load environment based on branch
      - name: Set environment name
        id: envname
        run: |
          BRANCH="${GITHUB_REF##*/}"
          if [[ "$BRANCH" == "dev" ]]; then echo "env=dev" >> $GITHUB_OUTPUT; fi
          if [[ "$BRANCH" == "test" ]]; then echo "env=test" >> $GITHUB_OUTPUT; fi
          if [[ "$BRANCH" == "stage" ]]; then echo "env=stage" >> $GITHUB_OUTPUT; fi
          if [[ "$BRANCH" == "master" ]]; then echo "env=production" >> $GITHUB_OUTPUT; fi
      # Export secrets to temporary env file for the build ONLY
      - name: Create .env.production dynamically
        run: |
          echo "NEXT_PUBLIC_API_URL="${{ secrets.NEXT_PUBLIC_API_URL }}" >> .env.production
          echo "NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}" >> .env.production
      - name: Install dependencies
        run: npm ci
      - name: Run Lint
        run: npm run lint
      - name: Build Project
        run: npm run build
  deploy:
    name: Deploy with Podman
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ needs.build.outputs.env }}
    steps:
      - uses: actions/checkout@v4
      # Set image tag per branch
      - name: Set image tag
        id: vars
        run: |
          BRANCH="${GITHUB_REF##*/}"
          if [[ "$BRANCH" == "dev" ]]; then echo "tag=dev" >> $GITHUB_OUTPUT; fi
          if [[ "$BRANCH" == "test" ]]; then echo "tag=test" >> $GITHUB_OUTPUT; fi
          if [[ "$BRANCH" == "stage" ]]; then echo "tag=stage" >> $GITHUB_OUTPUT; fi
          if [[ "$BRANCH" == "master" ]]; then echo "tag=latest" >> $GITHUB_OUTPUT; fi
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build & Push Image
        run: |
          IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag }}
          docker build \
            --build-arg NEXT_PUBLIC_API_URL="${{ secrets.NEXT_PUBLIC_API_URL }}" \
            --build-arg NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}" \
            -t $IMAGE .
          docker push $IMAGE
      - name: SSH Setup
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}
      - name: Deploy to VPS
        run: |
          BRANCH="${GITHUB_REF##*/}"

          if [[ "$BRANCH" == "test" ]]; then
            TARGET_DIR="eventsmap-test"
            COMPOSE_FILE="podman-compose.test.yml"
            TAG="test"
          elif [[ "$BRANCH" == "stage" ]]; then
            TARGET_DIR="eventsmap-stage"
            COMPOSE_FILE="podman-compose.stage.yml"
            TAG="stage"
          elif [[ "$BRANCH" == "master" ]]; then
            TARGET_DIR="eventsmap-prod"
            COMPOSE_FILE="podman-compose.prod.yml"
            TAG="latest"
          else
            echo "Dev branch does not deploy."
            exit 0
          fi

          # Upload compose file
          scp -P ${{ secrets.DEPLOY_PORT }} $COMPOSE_FILE \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }}:/home/minaxi/$TARGET_DIR/

          # Upload environment file
          ssh -p ${{ secrets.DEPLOY_PORT }} ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }} "
            echo 'NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}' > /home/minaxi/$TARGET_DIR/.env &&
            echo 'NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}' >> /home/minaxi/$TARGET_DIR/.env
          "

          # üîê LOGIN TO GHCR (IMPORTANT)
          ssh -p ${{ secrets.DEPLOY_PORT }} \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }} "
              echo '${{ secrets.GHCR_PAT }}' | podman login ghcr.io \
                -u ${{ github.actor }} --password-stdin
            "

          # üöÄ Deploy container
          ssh -p ${{ secrets.DEPLOY_PORT }} \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_SERVER }} "
              cd /home/minaxi/$TARGET_DIR &&
              podman pull ghcr.io/${{ env.IMAGE_NAME }}:$TAG &&
              podman-compose -f $COMPOSE_FILE up -d --force-recreate
            "
