name: Frontend CI/CD (OTAP)

on:
  push:
    branches:
      - dev
      - test
      - stage
      - master

jobs:
  # Step 1: Build and Test
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: npm ci

      - name: Run Lint
        run: npm run lint

      - name: Build Project
        run: npm run build

  # Step 2: Deploy (conditional by branch)
  deploy:
    name: Conditional Deploy
    runs-on: ubuntu-latest
    needs: build

    # Assign GitHub environment dynamically (so approvals can be used)
    environment: 
      name: ${{ github.ref_name }}
      url: https://${{ github.ref_name }}.eventsmap.com

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine Environment
        id: env_check
        run: |
          branch="${GITHUB_REF##*/}"
          echo "branch=$branch" >> $GITHUB_OUTPUT

      - name: Deploy based on branch
        run: |
          branch="${{ steps.env_check.outputs.branch }}"
          echo "Detected branch: $branch"
          
          if [[ "$branch" == "dev" ]]; then
            echo "üöÄ Deploying to DEV environment..."
            # Example: SSH or Docker command
            # ssh user@dev-server "cd /app && docker compose up -d --build"
          
          elif [[ "$branch" == "test" ]]; then
            echo "üß™ Deploying to TEST environment..."
            # ssh user@test-server "cd /app && docker compose up -d --build"

          elif [[ "$branch" == "stage" ]]; then
            echo "üß§ Deploying to STAGING environment (manual approval required)..."
            # ssh user@stage-server "cd /app && docker compose up -d --build"

          elif [[ "$branch" == "master" ]]; then
            echo "üî• Deploying to PRODUCTION environment (manual approval required)..."
            # ssh user@prod-server "cd /app && docker compose up -d --build"
          else
            echo "‚ö†Ô∏è Unknown branch, skipping deployment."
          fi
